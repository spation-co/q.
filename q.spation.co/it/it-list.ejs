<!DOCTYPE html>
<!--  Last Published: Fri Apr 03 2020 07:16:42 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="5e841deb90c306c1e67b8d3c" data-wf-site="5e7b9ae24c46c726e716ecf3" lang="en" xml:lang="en">

<head>
  <meta charset="utf-8">
  <title>Project Q</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="apple-touch-startup-image" href="images/splash/launch_640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="images/splash/launch_750x1294.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="images/splash/launch-1242x2148.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="images/splash/launch_1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="images/splash/launch_1536x2048.png" media="(min-device-width: 768px) and (max-device-width: 1024px) and (-webkit-min-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="images/splash/launch_1668x2224.png" media="(min-device-width: 834px) and (max-device-width: 834px) and (-webkit-min-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="images/splash/launch_2048x2732.png" media="(min-device-width: 1024px) and (max-device-width: 1024px) and (-webkit-min-device-pixel-ratio: 2) and (orientation: portrait)">
  <link href="/css/project-queue.webflow.css" rel="stylesheet" type="text/css">
  <script src="/js/angular.min.js" type="text/javascript"></script>
  <script src="/js/angular-cookies.min.js" type="text/javascript"></script>
  <script src="/js/texts-list.js" type="text/javascript"></script>
  <script type="text/javascript">
    ! function (o, c) {
      var n = c.documentElement,
        t = " w-mod-";
      n.className += t + "js", ("ontouchstart" in o || o.DocumentTouch && c instanceof DocumentTouch) && (n.className += t + "touch")
    }(window, document);
  </script>
  <link href="../images/favicon.ico" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.png" rel="apple-touch-icon">
  <link rel="manifest" href="/manifest.json">
  <style rel="stylesheet">
    .waiting {
      width: 100%;
      position: absolute;
      height: 100%;
      top: 0px;
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      left: 0px;
    }

    .waiting>span {
      width: 7px;
      height: 7px;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      background-color: #000;
      margin: 0 5px;

      border-radius: 50%;
      display: inline-block;
      animation-name: dots;
      animation-duration: 2s;
      animation-iteration-count: infinite;
      animation-timing-function: ease-in-out;
    }

    .waiting span:nth-child(2) {
      animation-delay: 0.4s;
    }

    .waiting span:nth-child(3) {
      animation-delay: 0.8s;
    }

    @keyframes dots {
      50% {
        opacity: 0;
        transform: scale(0.7) translateY(10px);
      }
    }

    .slider-label {
      width: 100%;
    }

    .slider-bar {
      width: 100%;
      transform: translateX(-12.5px);
    }

    .slider-value {
      margin-top: 5px;
    }

    .div-block-29 {
      margin-bottom: 20px;
    }

    .body {
      padding-right: 30px;
      padding-left: 30px;
    }

    @media only screen and (min-width: 490px) {
      .slider-text {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }

      .body {
        padding-right: 60px;
        padding-left: 60px;
      }

      .div-block-29 {
        margin-bottom: 40px;
      }

      .main_div-copy {
        margin-top: 45px !important;
      }

    }

    @media only screen and (min-width: 768px) {
      .slider {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;

      }

      .div-block-29 {
        margin-bottom: 60px;
      }

      .body {
        padding-right: 100px;
        padding-left: 100px;
      }

      .slider-bar,
      .slider-label {
        width: 50%;
      }

      .slider-value {
        margin-top: 0;
      }
    }
  </style>
</head>

<body class="body" ng-app="listApp" ng-controller="listCtrl">
  <div class="main_div-copy">
    <div class="header_div" style="text-align: center;">
      <div class="div-block-22">
        <h1 class="heading-2" ng-cloak>{{texts.heading2}}</h1>
      </div>
      <div class="div-block-47" style="margin-bottom: 35px;">
        <div class="div-block-46">
          <p class="paragraph-19" ng-cloak>{{texts.paragraph19ngbinding_1}}&nbsp;{{userAddress}}.</p>
        </div>
        <div>
          <div class="div-block-45"><a href="/location" class="link-6" ng-cloak>{{texts.link6}}</a></div>
        </div>
      </div>
      <div class="div-block-43 slider" style="width: 100%;margin-bottom: 35px;margin-left: auto;margin-right: auto;">
        <div class="div-block-48 slider-label">
          <div class="slider-text" style="margin-top: 20px;" ng-cloak>{{texts.slidertext}}
            <div class="slider-value" style="font-weight: bold;margin-left:10px;margin-right: 20px;font-size:18px;"
              ng-cloak>
              {{maxDistance}}&nbsp;km
            </div>
          </div>
        </div>
        <div slider class="slider-bar" style="width: 90%;margin-left: auto;margin-right:auto;position: relative;height:10px;border-radius: 5px;background-color: #d3d3d3;
              display:flex;flex-direction: column;justify-content: center;z-index: 0;margin-top: 25px;">
          <div
            style="left:5%;position: absolute;width:25px;height:25px;border-radius: 50%;background-color: #0e1c34;z-index:2;">
          </div>
          <div
            style="left:0;right:-25px;top:0;bottom:0;position: absolute;height:10px;border-radius: 5px;background-color: #d3d3d3;display:flex;flex-direction: column;justify-content: center;z-index:1;">
          </div>
        </div>
      </div>
    </div>
  </div>
  <div ng-if="supermarkets.length === 0" style="position: relative; width: 100%; height: 30px;margin-bottom: 30px;"
    class="waiting">
    <span></span><span></span><span></span>
  </div>
  <div class="div-block-33" ng-repeat="s in supermarkets" ng-if="$index < last && s.distance < maxDistance">
    <div class="div-block-31">
      <div class="div-block-35">
        <div class="div-block-39">
          <div class="div-block-36"
            ng-style='{"opacity": s.isClosed ? 0.4 : 1, "background-color": isClosed ? "#888": !s.isUptoDate ? "#0e1c34" :  s.pTime > 60 ? "#db2525" : s.pTime > 30 ? "#f0a61c" : "#327d83"}'>
            <div ng-if="!s.isClosed && s.isUptoDate" class="text-block-19" ng-cloak>{{s.pTime + " "}}min</div>
            <div ng-if="s.isClosed && !s.isUptoDate" class="text-block-19" ng-cloak>{{texts["text-block19ngscope_1"]}}</div>
            <div ng-if="!s.isClosed && !s.isUptoDate" class="text-block-19" ng-cloak>{{texts["text-block19ngscope_2"]}}</div>
          </div>
          <div class="div-block-38" style="text-align: center;"><a
              ng-style="{'cursor': s.isClosed ? 'not-allowed' : 'pointer'}"
              href="{{s.isClosed ? '#' : '/update/' + s._id}}" class="link-4" style="text-align: center;" ng-cloak>{{texts.link4}}</a></div>
        </div>
        <div class="div-block-34">
          <p class="paragraph-16" ng-cloak>{{s.name}}</p>
          <p class="paragraph-17" ng-cloak>{{s.address}}</p>
          <p class="paragraph-18" ng-cloak>{{s.distance + " "}}km
            <span ng-if="s.isUptoDate && s.updateTime && s.updateTime < 45">• {{texts.paragraph18}}&nbsp;{{s.updateTime + " minuti fa"}}</span></p>
        </div>
      </div>

    </div>
  </div>
  <div ng-if="!maxDistanceReached" class="div-block-28">
    <div class="div-block-30"><a href="#" ng-click="getNext()" class="link-3" ng-cloak>{{texts.link3}}</a></div>
  </div>
  <div ng-if="maxDistanceReached" class="div-block-28" style="margin-top: 30px;">
    <div class="div-block-30"><a href="#" style="color: #888;text-decoration: none;font-weight: normal;"
        ng-click="getNext()" class="link-3" ng-cloak>{{texts.paragraph19ngbinding_2}}</a></div>
  </div>

  <div class="div-block-29"><a href="/add" class="button-3 w-button" ng-cloak>{{texts.button3wbutton}}</a></div>
  </div>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.4.1.min.220afd743d.js?site=5e7b9ae24c46c726e716ecf3"
    type="text/javascript" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>
  <script src="../js/webflow.js" type="text/javascript"></script>
  <script type="text/javascript">
    var app = angular.module('listApp', ['ngCookies', 'textsList']);
    app.directive('slider', function () {
      return {
        restrict: 'EA',
        link: function (scope, element) {

          element.on('mousedown', () => {
            scope.$apply(function () {
              scope.width = element[0].getBoundingClientRect().width;
              scope.startX = element[0].getBoundingClientRect().left;
              scope.isMouseClicked = true;
              scope.showDistance = true;
            });
          });
          element.on('mousemove', (e) => {
            scope.$apply(function () {
              if (scope.isMouseClicked && scope.maxDistance <= 50 && scope.maxDistance >= 0) {
                const left = (e.pageX - scope.startX) * 100 / scope.width;
                if (left > 101 || left < 0 || !element[0].firstElementChild) return;
                element[0].firstElementChild.style.left = left + "%";
                scope.maxDistance = parseInt(left / 2);
              }
            });
          });
          element.on('mouseup', (e) => {
            scope.$apply(function () {
              scope.isMouseClicked = false;
              scope.showDistance = false;
            });
          });
          element.on('touchstart', () => {
            scope.$apply(function () {
              scope.width = element[0].getBoundingClientRect().width;
              scope.startX = element[0].getBoundingClientRect().left;
              scope.isMouseClicked = true;
              scope.showDistance = true;
            });
          });
          element.on('touchmove', (e) => {
            scope.$apply(function () {
              if (scope.isMouseClicked && scope.maxDistance <= 50 && scope.maxDistance >= 0) {
                var left;
                if (e.pageX) {
                  left = (e.pageX - scope.startX) * 100 / scope.width;
                } else {
                  left = (e.changedTouches[0].pageX - scope.startX) * 100 / scope.width;
                }
                if (left > 101 || left < 0 || !element[0].firstElementChild) return;
                element[0].firstElementChild.style.left = left + "%";
                scope.maxDistance = parseInt(left / 2);
              }
            });
          });
          element.on('touchend', (e) => {
            scope.$apply(function () {
              scope.isMouseClicked = false;
              scope.showDistance = false;
            });
          });
        }
      }
    });
    app.controller("listCtrl", function ($scope, $http, $cookies, $window, lang) {

      var language = $window.navigator.userLanguage || $window.navigator.language;
      console.log(language);
      switch (language) {
        case ("it") :
          language = "it";
          //console.log("language: italian");
          break;
        case ("it-IT") :
          language = "it";
          //console.log("language: italian");
          break;
        case ("en") :
          language = "en";
          //console.log("language: english");
          break;
        case ("en-UK") :
          language = "en";
          //console.log("language: english");
          break;
        case ("fr") :
          language = "fr";
          //console.log("language: french");
          break;
        case ("fr-FR") :
          language = "fr";
          //console.log("language: french");
          break;
        case ("es"):
          language = "es";
          //console.log("language: spanish");
          break;
        case ("es-ES"):
          language = "es";
          //console.log("language: spanish");
          break;
        default:
          language = "en";
          //console.log("language: deafault");
      }
      $scope.texts = lang[language];
      if (!$scope.texts) {
      $scope.texts = lang.en;
      } 

      var location = $cookies.get("qspationUserAddress");
      if (location) {
        $scope.userAddress = location;
      } else if (sessionStorage.getItem('qspationUserAddress')) {
        $scope.userAddress = sessionStorage.getItem('qspationUserAddress');
      } else {
        $window.location.href = '/location';
      }
      $scope.maxDistance = 5;
      $scope.showResults = false;
      $scope.last = 5;
      $scope.supermarkets = [];
      $scope.distances = [];
      $scope.maxDistanceReached = false;

      $scope.distance = (p1, p2) => {
        const r = 6371;
        const h1 = Math.sin((p1[0] - p2[0]) * Math.PI / 360);
        const h2 = Math.sin((p1[1] - p2[1]) * Math.PI / 360);

        const inner = h2 * h2 + Math.cos(p1[1] * Math.PI / 180) * Math.cos(p2[1] * Math.PI / 180) * h1 * h1;

        return (parseInt(2 * r * Math.asin(Math.sqrt(inner)) * 100)) / 100;
      };
      $scope.path = (address) => {
        return `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURI(address)}.json?types=address&access_token=pk.eyJ1IjoicXNwYXRpb24iLCJhIjoiY2s4MW85cm50MGJjdjNmbDkxZmtwY2ExbyJ9.qi-2tdukdDJhH7kZWttiRA`;
      };

      var getAverage = (arr) => {
        var sum = 0, len = 0;
        arr.forEach((item) => {
          if (typeof item === "number") { sum += item; len++; }
        });
        return len === 0 ? 1 : parseInt(sum / len); //se il vettore è inizialmente vuoto assumiamo come processing time 1 minuto
      }
      $scope.getNext = () => {
        var count = 0;
        while (count < 5 && $scope.supermarkets[$scope.last + count].distance < $scope.maxDistance) {
          count++;
        }
        $scope.last += 5;

        if (count < 5 || $scope.last === $scope.supermarkets.length) {
          $scope.maxDistanceReached = true;
        }
      };
      $scope.getNearest = async () => {

        var res = await $http.get($scope.path($scope.userAddress));

        var features = res.data.features;

        features.sort((a, b) => {
          a.relevance < b.relevance ? 1 : -1;
        });
        var coor = features[0].center;
        var D, date = new Date(), hrs = date.getHours();

        $scope.supermarkets.forEach((item, index) => {
          D = $scope.distance(coor, item.coordinates);
          $scope.supermarkets[index].distance = D;

          var str = (item.workingHours && item.workingHours.split("-")) || ["8", "20"];

          $scope.supermarkets[index].pTime = getAverage(item.processingTime)*item.people;
          $scope.supermarkets[index].isClosed =
            hrs < parseInt(str[0].split(":")[0].trim()) && hrs > parseInt(str[1].split(":")[0].trim());
          var isUptoDate = date.getTime() - new Date(item.lastupdate).getTime();
          $scope.supermarkets[index].updateTime = isNaN(isUptoDate) ? false : parseInt(isUptoDate / 60000);
          $scope.supermarkets[index].isUptoDate = isNaN(isUptoDate) ? false : isUptoDate < 2700000;
        });
        $scope.updateDistance = () => {

        };
        $scope.supermarkets.sort((a, b) => {
          return a.distance - b.distance;
        });

        $scope.$apply(() => { $scope.showResults = true; });
      };

      $http.get("/supermarkets")
        .then(function (response) {
          $scope.supermarkets = response.data;
          $scope.getNearest();
        }).catch((err) => {
        });
    });

  </script>
  <!-- [if lte IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif] -->
</body>


</html>
